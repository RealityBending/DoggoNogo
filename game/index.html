<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Doggo/Nogo: The Game</title>
        <style>
            :root {
                --target-width: 1792;
                --target-height: 1024;
            }
            body {
                margin: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background-color: #f0f0f0;
            }
            #canvasWrapper {
                position: relative;
            }
            canvas {
                border: 1px solid black;
                background-color: #000;
                display: block;
                width: 100%; /* CSS size; actual drawing buffer set in JS */
                height: auto;
                aspect-ratio: calc(var(--target-width) / var(--target-height));
            }
        </style>
    </head>
    <body>
        <div id="canvasWrapper">
            <canvas id="gameCanvas"></canvas>
        </div>

        <!-- STANDALONE VERSION OF THE GAME -->

        <!-- Shared UI helpers -->
        <script src="game.js"></script>
        <!-- Central game engine -->
        <script src="engine.js"></script>
        <!-- Intro runner -->
        <script src="intro.js"></script>
        <!-- Level-specific game logic -->
        <script src="levels/level1.js"></script>
        <script src="levels/intro.js"></script>
        <script src="levels/level2.js"></script>
        <!-- Main game manager -->
        <script>
            // This script is the entry point for the standalone game.
            // It finds the canvas, loads the necessary scripts, and starts the game engine.
            const TARGET_W = 1792
            const TARGET_H = 1024
            const ASPECT = TARGET_W / TARGET_H
            const canvas = document.getElementById("gameCanvas")

            function sizeCanvas() {
                const maxW = window.innerWidth
                const maxH = window.innerHeight
                // Constrain by width first
                let w = Math.min(TARGET_W, maxW)
                let h = Math.round(w / ASPECT)
                if (h > maxH) {
                    h = Math.min(TARGET_H, maxH)
                    w = Math.round(h * ASPECT)
                }
                // Set drawing buffer (for crisp rendering)
                const dpr = window.devicePixelRatio || 1
                canvas.width = Math.round(w * dpr)
                canvas.height = Math.round(h * dpr)
                // Set CSS size
                canvas.style.width = w + "px"
                canvas.style.height = h + "px"
                const ctx = canvas.getContext("2d")
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0)
            }

            sizeCanvas()
            window.addEventListener("resize", () => {
                sizeCanvas()
                // Let current running level recompute sprite sizes/positions (engine also listens, but call directly for immediate effect)
                if (window.DoggoNogoEngine && DoggoNogoEngine.level && typeof DoggoNogoEngine.level.handleResize === "function") {
                    DoggoNogoEngine.level.handleResize()
                }
            })

            // The DoggoNogoEngine, DoggoNogoUI, and level objects are expected to be available globally.
            async function preloadLevels() {
                if (!canvas) return
                // Create a temporary context for sizing; actual sizing already done.
                const preloadOptions = { assetBasePath: "assets/" }
                try {
                    if (level1 && !level1._loaded) {
                        await level1.load(canvas, preloadOptions)
                        level1._loaded = true
                    }
                    if (level2 && !level2._loaded) {
                        await level2.load(canvas, preloadOptions)
                        level2._loaded = true
                    }
                } catch (e) {
                    console.warn("Preload failed", e)
                }
            }

            function runLevel1() {
                DoggoNogoEngine.run(canvas, level1, {
                    assetBasePath: "assets/",
                    introSequence: typeof level1IntroSequence !== "undefined" ? level1IntroSequence : null,
                    continueHint: "Press SPACE to continue",
                    suppressLoading: true, // already preloaded
                    onFinish: () => {
                        const proceed = (e) => {
                            if (e.code === "Space") {
                                document.removeEventListener("keydown", proceed)
                                runLevel2()
                            }
                        }
                        document.addEventListener("keydown", proceed)
                    },
                })
            }

            function runLevel2() {
                if (typeof level2 === "undefined") {
                    console.error("Level 2 script not loaded.")
                    return
                }
                DoggoNogoEngine.run(canvas, level2, {
                    assetBasePath: "assets/",
                    skipCover: true, // start directly at level 2 instruction screen
                    introSequence: typeof level2IntroSequence !== "undefined" ? level2IntroSequence : null,
                    continueHint: "Press SPACE to finish",
                    suppressLoading: true, // preloaded
                    onFinish: (state) => {
                        console.log("All levels finished. Final state level2:", state)
                    },
                })
            }

            ;(async () => {
                if (
                    !canvas ||
                    typeof DoggoNogoEngine === "undefined" ||
                    typeof level1 === "undefined" ||
                    typeof DoggoNogoUI === "undefined"
                ) {
                    console.error("Could not start level 1. Ensure canvas, engine, UI, and level scripts are loaded.")
                    return
                }
                // Engine now performs global + level preload internally; just call run after slight defer for paint.
                if (typeof DoggoNogoCore !== "undefined" && DoggoNogoCore.renderLoadingScreen) {
                    DoggoNogoCore.renderLoadingScreen(canvas, "Loading the game...")
                }
                setTimeout(() => runLevel1(), 150)
            })()
        </script>
    </body>
</html>
